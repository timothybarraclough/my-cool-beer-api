language: minimal
services:
- docker
branches:
  only:
  - master
stages:
- build docker image
- name: deploy
  if: type != pull_request
- name: test deployment
  if: type != pull_request
env:
  secure: "KSrppxNmTjvONsE/3Q/DR56FuzHOJOjJcpTwH8R8+JAu3HSeuHE5LXigNiHXuB7edpWyxWJQcvN5fg3ABUGoVPZBcqIqp9vFlw1ZCq9vJue3t7WwhDxytLvxHYhIidR+H6CJ8AkzqoMs1+9QtFn3r3k4Pn9ZvtR+eADo92gEFmiAnFjyJ9q0eP7AsP7o4JP749LlaBk7dXQRBLyV/cEHEY65nnDZmZLd48U0QHB/EDPKrO/ym1mNExJJrWPAz0ERLAlQLv8BFnuQgaMVzCqddEPUePKUC2LH1+fT1surUWsHujNJ8T3Sjsgep1CCgK2PyzOjk/Xwj6hU3THB6FSOqJbiYspyIXbJBCc+3x8HBVPVPsuNWWIvmcgOkuZcYXGlxIGIJoJlazhH7kV6x8T2L8qEiZzckdy64LV+vUa4USAkpdS7+5DXeAn+Mn9rpAZ/AysGGdcFWxWp8OvORI9h8OcXauOcDoP1uJ1ovz57hqUV2UfG71LsjeTNQ9fh8qhgbAQr+BhfB4+v91QG1TIeZLr+kkLJa8JQFlWzS7Q3gguFaDOA3rKDvK/ewCUBiong7nNkHjIMvxAEbWWqU8PPy+ZCHlOWDYKH05F/K3dOWKp9LhubnUmIfMZL08zJKS3FzJLxphYiVUxT1UlZELqQkl8H2y7kxsUln2di0wrRaGc="
jobs:
  include:
  - stage: build docker image
    script:
    - docker login -u _ registry.heroku.com --password $HEROKU_API_KEY
    - export CONTAINER_NAME=registry.heroku.com/my-cool-beer-api/web:$(git rev-parse
      --short HEAD^2)
    - if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then export CACHE_CONTAINER=$CONTAINER_NAME;
      else export CACHE_CONTAINER="registry.heroku.com/my-cool-beer-api/web:build";
      fi
    - docker pull $CACHE_CONTAINER || true
    - docker build --cache-from $CACHE_CONTAINER -t $CONTAINER_NAME .
    - docker push $CONTAINER_NAME
    - docker tag $CONTAINER_NAME registry.heroku.com/my-cool-beer-api/web:build
    - docker push registry.heroku.com/my-cool-beer-api/web:build
  - stage: deploy
    script:
    - docker login -u _ registry.heroku.com --password-stdin $HEROKU_API_KEY
    - export CONTAINER_NAME=registry.heroku.com/my-cool-beer-api/web:$(git rev-parse
      --short HEAD^2)
    - docker pull $CONTAINER_NAME
    - docker tag $CONTAINER_NAME registry.heroku.com/my-cool-beer-api/web:latest
    - docker push registry.heroku.com/my-cool-beer-api/web:latest
    - wget -qO- https://cli-assets.heroku.com/install.sh | sh
    - heroku container:release web -a my-cool-beer-api
  - stage: test deployment
    script: curl https://my-cool-beer-api.herokuapp.com/brewers
